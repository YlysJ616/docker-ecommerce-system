# 数据库设计文档

## 数据库概述

- **数据库类型**: MySQL 8.0
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci
- **存储引擎**: InnoDB
- **时区**: Asia/Shanghai

---

## 数据库配置

### 连接信息
```yaml
Host: localhost (容器内为 db)
Port: 3307 (宿主机) / 3306 (容器内)
Database: ecommerce
Username: ecommerce_user
Password: ecommerce_pass
Root Password: root123
```

### 字符集配置
```sql
SET NAMES utf8mb4;
SET CHARACTER SET utf8mb4;
```

### 数据库创建
```sql
CREATE DATABASE IF NOT EXISTS ecommerce 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;
```

---

## 表结构设计

### 1. products (商品表)

#### 表结构
```sql
CREATE TABLE IF NOT EXISTS products (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '商品ID',
    name VARCHAR(255) NOT NULL COMMENT '商品名称',
    description TEXT COMMENT '商品描述',
    price DECIMAL(10, 2) NOT NULL COMMENT '商品价格',
    stock INT NOT NULL DEFAULT 0 COMMENT '库存数量',
    category VARCHAR(100) COMMENT '商品分类',
    image_url VARCHAR(500) COMMENT '图片URL',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_category (category) COMMENT '分类索引',
    INDEX idx_name (name) COMMENT '名称索引'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='商品表';
```

#### 字段说明

| 字段名 | 数据类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|---------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主键，自增ID |
| name | VARCHAR | 255 | NO | - | 商品名称 |
| description | TEXT | - | YES | NULL | 商品详细描述 |
| price | DECIMAL | 10,2 | NO | - | 商品价格，精度10位，小数2位 |
| stock | INT | - | NO | 0 | 库存数量 |
| category | VARCHAR | 100 | YES | NULL | 商品分类 |
| image_url | VARCHAR | 500 | YES | NULL | 商品图片URL |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 更新时间，自动更新 |

#### 索引设计

| 索引名 | 索引类型 | 字段 | 说明 |
|--------|---------|------|------|
| PRIMARY | 主键索引 | id | 主键 |
| idx_category | 普通索引 | category | 加速分类查询 |
| idx_name | 普通索引 | name | 加速名称搜索 |

#### 约束说明
- **主键约束**: id 字段为主键，自增
- **非空约束**: name, price, stock, created_at, updated_at 不允许为空
- **默认值**: stock 默认为 0
- **自动更新**: updated_at 在记录更新时自动更新

---

### 2. users (用户表)

#### 表结构
```sql
CREATE TABLE IF NOT EXISTS users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '用户ID',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
    email VARCHAR(100) NOT NULL UNIQUE COMMENT '邮箱',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

#### 字段说明

| 字段名 | 数据类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|---------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主键，自增ID |
| username | VARCHAR | 50 | NO | - | 用户名，唯一 |
| email | VARCHAR | 100 | NO | - | 邮箱，唯一 |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 创建时间 |

#### 索引设计

| 索引名 | 索引类型 | 字段 | 说明 |
|--------|---------|------|------|
| PRIMARY | 主键索引 | id | 主键 |
| username | 唯一索引 | username | 用户名唯一 |
| email | 唯一索引 | email | 邮箱唯一 |

---

## 初始化数据

### 商品数据（40+ 条）

#### 分类统计
- 手机: 6 款
- 电脑: 6 款
- 平板: 4 款
- 智能手表: 5 款
- 配件: 6 款
- 相机: 4 款
- 智能家居: 5 款

#### 示例数据
```sql
INSERT INTO products (name, description, price, stock, category, image_url) VALUES
('iPhone 15 Pro Max', '苹果最新旗舰手机，A17 Pro芯片，钛金属边框，6.7英寸超视网膜XDR显示屏', 9999.00, 50, '手机', 'https://images.unsplash.com/photo-1678652197831-2d180705cd2c?w=400&h=400&fit=crop'),
('MacBook Pro 14', 'M3 Pro芯片，16GB内存，512GB存储，Liquid视网膜XDR显示屏', 15999.00, 30, '电脑', 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?w=400&h=400&fit=crop'),
-- ... 更多数据
```

### 用户数据
```sql
INSERT INTO users (username, email) VALUES
('admin', 'admin@example.com'),
('user1', 'user1@example.com');
```

---

## 数据库优化

### 1. 索引优化

#### 已创建索引
```sql
-- 分类索引（加速分类查询）
CREATE INDEX idx_category ON products(category);

-- 名称索引（加速搜索）
CREATE INDEX idx_name ON products(name);
```

#### 索引使用场景
```sql
-- 使用分类索引
SELECT * FROM products WHERE category = '手机';

-- 使用名称索引
SELECT * FROM products WHERE name LIKE '%iPhone%';
```

### 2. 查询优化

#### 分页查询
```sql
-- 使用 LIMIT 分页
SELECT * FROM products 
ORDER BY created_at DESC 
LIMIT 0, 12;  -- 第1页，每页12条

SELECT * FROM products 
ORDER BY created_at DESC 
LIMIT 12, 12;  -- 第2页，每页12条
```

#### 统计查询
```sql
-- 按分类统计商品数量
SELECT category, COUNT(*) as count 
FROM products 
GROUP BY category;

-- 计算总库存
SELECT SUM(stock) as total_stock 
FROM products;

-- 计算平均价格
SELECT AVG(price) as avg_price 
FROM products;
```

### 3. 连接池配置

#### HikariCP 配置
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 10      # 最大连接数
      minimum-idle: 5            # 最小空闲连接数
      connection-timeout: 30000  # 连接超时（毫秒）
      idle-timeout: 600000       # 空闲超时（毫秒）
      max-lifetime: 1800000      # 最大生命周期（毫秒）
      connection-init-sql: SET NAMES utf8mb4  # 初始化SQL
```

---

## 数据备份与恢复

### 备份数据库

#### 完整备份
```bash
# 备份整个数据库
docker-compose exec db mysqldump -u root -proot123 ecommerce > backup.sql

# 备份特定表
docker-compose exec db mysqldump -u root -proot123 ecommerce products > products_backup.sql

# 备份结构和数据
docker-compose exec db mysqldump -u root -proot123 --databases ecommerce > full_backup.sql
```

#### 仅备份结构
```bash
docker-compose exec db mysqldump -u root -proot123 --no-data ecommerce > structure.sql
```

#### 仅备份数据
```bash
docker-compose exec db mysqldump -u root -proot123 --no-create-info ecommerce > data.sql
```

### 恢复数据库

#### 恢复完整数据库
```bash
docker-compose exec -T db mysql -u root -proot123 ecommerce < backup.sql
```

#### 恢复特定表
```bash
docker-compose exec -T db mysql -u root -proot123 ecommerce < products_backup.sql
```

---

## 数据维护

### 1. 表维护

#### 分析表
```sql
ANALYZE TABLE products;
```

#### 优化表
```sql
OPTIMIZE TABLE products;
```

#### 检查表
```sql
CHECK TABLE products;
```

#### 修复表
```sql
REPAIR TABLE products;
```

### 2. 清理数据

#### 删除过期数据
```sql
-- 删除30天前创建的商品
DELETE FROM products 
WHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

#### 清空表
```sql
TRUNCATE TABLE products;
```

### 3. 查看表信息

#### 表大小
```sql
SELECT 
    table_name AS 'Table',
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)'
FROM information_schema.TABLES
WHERE table_schema = 'ecommerce'
ORDER BY (data_length + index_length) DESC;
```

#### 表行数
```sql
SELECT 
    table_name AS 'Table',
    table_rows AS 'Rows'
FROM information_schema.TABLES
WHERE table_schema = 'ecommerce';
```

---

## 性能监控

### 1. 慢查询日志

#### 启用慢查询日志
```sql
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;  -- 超过2秒的查询
```

#### 查看慢查询
```bash
docker-compose exec db cat /var/log/mysql/slow.log
```

### 2. 查询分析

#### EXPLAIN 分析
```sql
EXPLAIN SELECT * FROM products WHERE category = '手机';
```

#### 查看索引使用情况
```sql
SHOW INDEX FROM products;
```

### 3. 连接监控

#### 查看当前连接
```sql
SHOW PROCESSLIST;
```

#### 查看连接数
```sql
SHOW STATUS LIKE 'Threads_connected';
SHOW STATUS LIKE 'Max_used_connections';
```

---

## 安全配置

### 1. 用户权限

#### 创建应用用户
```sql
CREATE USER 'ecommerce_user'@'%' IDENTIFIED BY 'ecommerce_pass';
GRANT SELECT, INSERT, UPDATE, DELETE ON ecommerce.* TO 'ecommerce_user'@'%';
FLUSH PRIVILEGES;
```

#### 限制权限
```sql
-- 只读用户
CREATE USER 'readonly'@'%' IDENTIFIED BY 'readonly_pass';
GRANT SELECT ON ecommerce.* TO 'readonly'@'%';
FLUSH PRIVILEGES;
```

### 2. 密码策略

#### 修改密码
```sql
ALTER USER 'ecommerce_user'@'%' IDENTIFIED BY 'new_password';
```

### 3. 连接限制

#### 限制连接数
```sql
ALTER USER 'ecommerce_user'@'%' WITH MAX_CONNECTIONS_PER_HOUR 1000;
```

---

## 常见问题

### Q1: 中文乱码问题
**解决方案**: 确保使用 utf8mb4 字符集
```sql
ALTER DATABASE ecommerce CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
ALTER TABLE products CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### Q2: 时区问题
**解决方案**: 设置时区
```sql
SET GLOBAL time_zone = '+8:00';
```

### Q3: 连接数过多
**解决方案**: 调整最大连接数
```sql
SET GLOBAL max_connections = 200;
```

### Q4: 表锁问题
**解决方案**: 使用 InnoDB 引擎（行级锁）
```sql
ALTER TABLE products ENGINE=InnoDB;
```

---

## ER 图

```
┌─────────────────────┐
│      products       │
├─────────────────────┤
│ id (PK)            │
│ name               │
│ description        │
│ price              │
│ stock              │
│ category           │
│ image_url          │
│ created_at         │
│ updated_at         │
└─────────────────────┘

┌─────────────────────┐
│       users         │
├─────────────────────┤
│ id (PK)            │
│ username (UNIQUE)  │
│ email (UNIQUE)     │
│ created_at         │
└─────────────────────┘
```

---

## 数据字典

完整的数据字典请参考上述表结构设计部分。
