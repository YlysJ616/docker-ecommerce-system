# 故障排查文档

## 常见问题速查表

| 问题 | 可能原因 | 解决方案 |
|------|---------|---------|
| 容器无法启动 | 端口被占用 | 检查端口占用，修改端口映射 |
| 数据库连接失败 | 数据库未就绪 | 等待健康检查通过 |
| 前端无法访问 | Nginx 配置错误 | 检查 nginx.conf |
| API 404 错误 | 路由配置错误 | 检查 Controller 路径 |
| 镜像构建失败 | 网络问题 | 配置镜像加速器 |

---

## 1. 容器启动问题

### 问题：容器无法启动

#### 症状
```bash
$ docker-compose up -d
ERROR: for ecommerce-backend  Cannot start service backend: driver failed programming external connectivity
```

#### 原因
- 端口被占用
- Docker 服务未启动
- 资源不足

#### 解决方案

**检查端口占用**
```bash
# Windows
netstat -ano | findstr :8080
taskkill /PID <进程ID> /F

# Linux/macOS
lsof -i :8080
kill -9 <进程ID>
```

**检查 Docker 服务**
```bash
# Windows/macOS
# 启动 Docker Desktop

# Linux
sudo systemctl start docker
sudo systemctl status docker
```

**检查资源**
```bash
# 查看系统资源
docker system df

# 清理未使用资源
docker system prune -a
```

---

### 问题：容器启动后立即退出

#### 症状
```bash
$ docker-compose ps
NAME                 STATUS
ecommerce-backend    Exited (1)
```

#### 原因
- 应用启动失败
- 配置错误
- 依赖服务未就绪

#### 解决方案

**查看日志**
```bash
docker-compose logs backend
```

**常见错误及解决**

1. **数据库连接失败**
```
Error: Could not connect to database
```
解决：等待数据库健康检查通过
```bash
docker-compose ps db
# 确保状态为 (healthy)
```

2. **端口已被占用**
```
Error: Port 8080 is already in use
```
解决：修改端口映射
```yaml
ports:
  - "8081:8080"
```

3. **环境变量缺失**
```
Error: Required environment variable not set
```
解决：检查 docker-compose.yml 中的 environment 配置

---

## 2. 网络问题

### 问题：容器间无法通信

#### 症状
```bash
$ docker-compose exec backend ping db
ping: db: Name or service not known
```

#### 原因
- 网络配置错误
- 服务名拼写错误
- 网络未创建

#### 解决方案

**检查网络**
```bash
# 查看网络列表
docker network ls

# 查看网络详情
docker network inspect docker_ecommerce-network

# 重新创建网络
docker-compose down
docker-compose up -d
```

**测试连接**
```bash
# 从后端 ping 数据库
docker-compose exec backend ping db

# 从后端访问数据库
docker-compose exec backend nc -zv db 3306
```

---

### 问题：前端无法访问后端 API

#### 症状
- 浏览器控制台显示 404 或 502 错误
- API 请求失败

#### 原因
- Nginx 代理配置错误
- 后端服务未启动
- 网络配置问题

#### 解决方案

**检查 Nginx 配置**
```bash
# 查看配置文件
docker-compose exec frontend cat /etc/nginx/conf.d/nginx.conf

# 测试配置
docker-compose exec frontend nginx -t

# 重新加载配置
docker-compose exec frontend nginx -s reload
```

**检查后端状态**
```bash
# 查看后端容器状态
docker-compose ps backend

# 测试后端 API
curl http://localhost:8080/api/products

# 从前端容器测试
docker-compose exec frontend curl http://backend:8080/api/products
```

**检查浏览器控制台**
```
F12 → Network → 查看失败的请求
```

---

## 3. 数据库问题

### 问题：数据库连接失败

#### 症状
```
Error: Communications link failure
```

#### 原因
- 数据库未启动
- 连接字符串错误
- 用户名密码错误
- 网络问题

#### 解决方案

**检查数据库状态**
```bash
# 查看容器状态
docker-compose ps db

# 查看数据库日志
docker-compose logs db

# 进入数据库容器
docker-compose exec db bash

# 测试登录
mysql -u root -proot123
```

**检查连接配置**
```yaml
environment:
  SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/ecommerce
  SPRING_DATASOURCE_USERNAME: ecommerce_user
  SPRING_DATASOURCE_PASSWORD: ecommerce_pass
```

**测试连接**
```bash
# 从后端容器测试
docker-compose exec backend nc -zv db 3306
```

---

### 问题：数据库初始化失败

#### 症状
- 表不存在
- 数据为空

#### 原因
- 初始化脚本未执行
- 脚本语法错误
- 卷已存在（脚本不会重新执行）

#### 解决方案

**重新初始化**
```bash
# 删除数据卷
docker-compose down -v

# 重新启动
docker-compose up -d

# 查看初始化日志
docker-compose logs db | grep "init"
```

**手动执行脚本**
```bash
# 复制脚本到容器
docker cp database/init-chinese.sql ecommerce-db:/tmp/

# 执行脚本
docker-compose exec db mysql -u root -proot123 ecommerce < /tmp/init-chinese.sql
```

**检查数据**
```bash
docker-compose exec db mysql -u root -proot123 -e "USE ecommerce; SELECT COUNT(*) FROM products;"
```

---

## 4. 镜像构建问题

### 问题：镜像构建失败

#### 症状
```
ERROR: failed to solve: process "/bin/sh -c mvn clean package" did not complete successfully
```

#### 原因
- 网络问题
- 依赖下载失败
- 构建超时
- 磁盘空间不足

#### 解决方案

**配置 Maven 镜像**
在 `backend/pom.xml` 中添加：
```xml
<repositories>
    <repository>
        <id>aliyun</id>
        <url>https://maven.aliyun.com/repository/public</url>
    </repository>
</repositories>
```

**增加构建超时**
```bash
DOCKER_BUILDKIT=1 docker-compose build --build-arg BUILDKIT_INLINE_CACHE=1
```

**清理缓存重新构建**
```bash
docker-compose build --no-cache
```

**检查磁盘空间**
```bash
df -h
docker system df
```

---

## 5. 性能问题

### 问题：应用响应缓慢

#### 症状
- API 请求超时
- 页面加载慢
- 数据库查询慢

#### 原因
- 资源不足
- 数据库未优化
- 网络延迟

#### 解决方案

**查看资源使用**
```bash
# 查看容器资源
docker stats

# 查看系统资源
top  # Linux/macOS
taskmgr  # Windows
```

**优化数据库**
```sql
-- 添加索引
CREATE INDEX idx_category ON products(category);
CREATE INDEX idx_name ON products(name);

-- 分析表
ANALYZE TABLE products;
```

**增加资源限制**
```yaml
backend:
  deploy:
    resources:
      limits:
        cpus: '2'
        memory: 1G
```

---

## 6. 日志问题

### 问题：日志过多占用磁盘

#### 症状
```bash
$ df -h
/dev/sda1  50G  45G  5G  90% /
```

#### 解决方案

**配置日志限制**
```yaml
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

**清理日志**
```bash
# 清理所有容器日志
truncate -s 0 /var/lib/docker/containers/*/*-json.log

# 或重启 Docker
sudo systemctl restart docker
```

---

## 7. 数据持久化问题

### 问题：数据丢失

#### 症状
- 重启后数据消失
- 商品列表为空

#### 原因
- 未配置数据卷
- 使用了 `docker-compose down -v`
- 卷被删除

#### 解决方案

**检查卷配置**
```yaml
volumes:
  - db_data:/var/lib/mysql
```

**查看卷**
```bash
docker volume ls
docker volume inspect docker_db_data
```

**恢复数据**
```bash
# 从备份恢复
docker-compose exec -T db mysql -u root -proot123 ecommerce < backup.sql
```

---

## 8. 健康检查问题

### 问题：容器一直显示 unhealthy

#### 症状
```bash
$ docker-compose ps
NAME                 STATUS
ecommerce-backend    Up (unhealthy)
```

#### 原因
- 应用启动慢
- 健康检查配置错误
- 端口未开放

#### 解决方案

**增加启动等待时间**
```yaml
healthcheck:
  start_period: 60s  # 增加到 60 秒
```

**检查健康检查命令**
```bash
# 手动执行健康检查
docker-compose exec backend curl -f http://localhost:8080/actuator/health
```

**查看详细状态**
```bash
docker inspect ecommerce-backend | grep Health -A 10
```

---

## 9. 权限问题

### 问题：权限被拒绝

#### 症状
```
Error: Permission denied
```

#### 原因
- 文件权限不足
- 用户权限不足
- SELinux 限制

#### 解决方案

**修改文件权限**
```bash
chmod -R 755 frontend/html
chmod -R 755 backend/src
```

**使用 sudo**
```bash
sudo docker-compose up -d
```

**添加用户到 docker 组**
```bash
sudo usermod -aG docker $USER
newgrp docker
```

---

## 10. 浏览器缓存问题

### 问题：前端更新不生效

#### 症状
- 修改了代码但页面没变化
- 样式不更新

#### 原因
- 浏览器缓存
- Docker 镜像缓存

#### 解决方案

**清除浏览器缓存**
```
Ctrl + Shift + Delete (清除缓存)
Ctrl + F5 (强制刷新)
```

**重新构建镜像**
```bash
docker-compose build --no-cache frontend
docker-compose up -d frontend
```

**使用无痕模式测试**
```
Ctrl + Shift + N (Chrome)
Ctrl + Shift + P (Firefox)
```

---

## 诊断工具

### 1. 查看完整日志
```bash
docker-compose logs --tail=1000 > debug.log
```

### 2. 导出容器信息
```bash
docker inspect ecommerce-backend > backend-inspect.json
```

### 3. 网络诊断
```bash
docker network inspect docker_ecommerce-network > network-info.json
```

### 4. 资源使用报告
```bash
docker stats --no-stream > stats.txt
```

---

## 获取帮助

如果以上方法都无法解决问题：

1. **查看完整日志**
```bash
docker-compose logs > full-logs.txt
```

2. **收集系统信息**
```bash
docker version
docker-compose version
docker info
```

3. **提交 Issue**
访问 GitHub 仓库提交问题，附上：
- 错误信息
- 完整日志
- 系统信息
- 复现步骤
