# 部署运行指南

## 环境要求

### 必需软件
- **Docker**: 20.10 或更高版本
- **Docker Compose**: 2.0 或更高版本
- **Git**: 用于克隆项目

### 系统要求
- **操作系统**: Linux / macOS / Windows 10+
- **内存**: 至少 4GB RAM
- **磁盘**: 至少 10GB 可用空间
- **CPU**: 2核或以上

### 端口要求
确保以下端口未被占用：
- `80`: 前端服务
- `8080`: 后端服务
- `3307`: 数据库服务

---

## 快速开始

### 1. 克隆项目
```bash
git clone https://github.com/YlysJ616/docker-ecommerce-system.git
cd docker-ecommerce-system
```

### 2. 启动服务
```bash
docker-compose up -d
```

### 3. 等待服务启动
```bash
# 查看服务状态
docker-compose ps

# 查看启动日志
docker-compose logs -f
```

### 4. 访问应用
- **前端页面**: http://localhost
- **后端API**: http://localhost:8080/api/products
- **健康检查**: http://localhost:8080/actuator/health

---

## 详细部署步骤

### 步骤1: 安装 Docker

#### Windows
1. 下载 [Docker Desktop for Windows](https://www.docker.com/products/docker-desktop)
2. 运行安装程序
3. 启动 Docker Desktop
4. 验证安装：
```bash
docker --version
docker-compose --version
```

#### macOS
1. 下载 [Docker Desktop for Mac](https://www.docker.com/products/docker-desktop)
2. 拖拽到 Applications 文件夹
3. 启动 Docker
4. 验证安装：
```bash
docker --version
docker-compose --version
```

#### Linux (Ubuntu/Debian)
```bash
# 更新包索引
sudo apt-get update

# 安装依赖
sudo apt-get install ca-certificates curl gnupg

# 添加 Docker 官方 GPG 密钥
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg

# 添加 Docker 仓库
echo \
  "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 安装 Docker
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# 验证安装
docker --version
docker compose version
```

### 步骤2: 克隆项目
```bash
# 使用 HTTPS
git clone https://github.com/YlysJ616/docker-ecommerce-system.git

# 或使用 SSH
git clone git@github.com:YlysJ616/docker-ecommerce-system.git

# 进入项目目录
cd docker-ecommerce-system
```

### 步骤3: 检查配置
```bash
# 查看 docker-compose.yml
cat docker-compose.yml

# 检查端口是否被占用
# Windows
netstat -ano | findstr :80
netstat -ano | findstr :8080
netstat -ano | findstr :3307

# Linux/macOS
lsof -i :80
lsof -i :8080
lsof -i :3307
```

### 步骤4: 构建镜像
```bash
# 构建所有镜像
docker-compose build

# 或不使用缓存构建
docker-compose build --no-cache

# 并行构建（更快）
docker-compose build --parallel
```

### 步骤5: 启动服务
```bash
# 后台启动所有服务
docker-compose up -d

# 或前台启动（查看日志）
docker-compose up
```

### 步骤6: 验证部署
```bash
# 查看容器状态
docker-compose ps

# 应该看到类似输出：
# NAME                 STATUS                   PORTS
# ecommerce-db         Up (healthy)             0.0.0.0:3307->3306/tcp
# ecommerce-backend    Up (healthy)             0.0.0.0:8080->8080/tcp
# ecommerce-frontend   Up (healthy)             0.0.0.0:80->80/tcp

# 查看日志
docker-compose logs

# 测试后端健康检查
curl http://localhost:8080/actuator/health

# 测试前端
curl http://localhost/health.html

# 测试 API
curl http://localhost:8080/api/products
```

---

## 服务管理

### 启动服务
```bash
# 启动所有服务
docker-compose up -d

# 启动特定服务
docker-compose up -d frontend
docker-compose up -d backend
docker-compose up -d db
```

### 停止服务
```bash
# 停止所有服务
docker-compose stop

# 停止特定服务
docker-compose stop frontend
```

### 重启服务
```bash
# 重启所有服务
docker-compose restart

# 重启特定服务
docker-compose restart backend
```

### 停止并删除
```bash
# 停止并删除容器
docker-compose down

# 停止并删除容器和卷（清除所有数据）
docker-compose down -v

# 停止并删除容器、卷和镜像
docker-compose down -v --rmi all
```

### 查看日志
```bash
# 查看所有服务日志
docker-compose logs

# 实时查看日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs frontend
docker-compose logs backend
docker-compose logs db

# 查看最近 100 行日志
docker-compose logs --tail=100
```

### 进入容器
```bash
# 进入后端容器
docker-compose exec backend sh

# 进入数据库容器
docker-compose exec db bash

# 进入前端容器
docker-compose exec frontend sh
```

---

## 数据管理

### 数据备份
```bash
# 备份数据库
docker-compose exec db mysqldump -u root -proot123 ecommerce > backup.sql

# 备份数据卷
docker run --rm -v docker_db_data:/data -v $(pwd):/backup alpine tar czf /backup/db_backup.tar.gz /data
```

### 数据恢复
```bash
# 恢复数据库
docker-compose exec -T db mysql -u root -proot123 ecommerce < backup.sql

# 恢复数据卷
docker run --rm -v docker_db_data:/data -v $(pwd):/backup alpine tar xzf /backup/db_backup.tar.gz -C /
```

### 清理数据
```bash
# 清理所有数据
docker-compose down -v

# 重新初始化
docker-compose up -d
```

---

## 更新部署

### 更新代码
```bash
# 拉取最新代码
git pull origin main

# 重新构建镜像
docker-compose build

# 重启服务
docker-compose up -d
```

### 滚动更新
```bash
# 更新后端服务（零停机）
docker-compose up -d --no-deps --build backend

# 更新前端服务
docker-compose up -d --no-deps --build frontend
```

---

## 性能优化

### 1. 资源限制
编辑 `docker-compose.yml`：
```yaml
backend:
  deploy:
    resources:
      limits:
        cpus: '1'
        memory: 512M
      reservations:
        cpus: '0.5'
        memory: 256M
```

### 2. 日志限制
```yaml
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

### 3. 清理未使用资源
```bash
# 清理未使用的容器
docker container prune

# 清理未使用的镜像
docker image prune

# 清理未使用的卷
docker volume prune

# 清理所有未使用资源
docker system prune -a
```

---

## 监控与维护

### 查看资源使用
```bash
# 查看容器资源使用
docker stats

# 查看特定容器
docker stats ecommerce-backend
```

### 健康检查
```bash
# 后端健康检查
curl http://localhost:8080/actuator/health

# 前端健康检查
curl http://localhost/health.html

# 数据库健康检查
docker-compose exec db mysqladmin ping -h localhost -u root -proot123
```

### 日志分析
```bash
# 查看错误日志
docker-compose logs | grep ERROR

# 查看警告日志
docker-compose logs | grep WARN

# 导出日志
docker-compose logs > logs.txt
```

---

## 故障排查

### 服务无法启动
```bash
# 1. 查看详细日志
docker-compose logs backend

# 2. 检查端口占用
netstat -ano | findstr :8080

# 3. 检查容器状态
docker-compose ps

# 4. 重新构建
docker-compose build --no-cache
docker-compose up -d
```

### 数据库连接失败
```bash
# 1. 检查数据库状态
docker-compose ps db

# 2. 查看数据库日志
docker-compose logs db

# 3. 测试连接
docker-compose exec backend ping db

# 4. 进入数据库检查
docker-compose exec db mysql -u root -proot123
```

### 前端无法访问后端
```bash
# 1. 检查网络
docker network inspect docker_ecommerce-network

# 2. 测试后端
curl http://localhost:8080/api/products

# 3. 检查 Nginx 配置
docker-compose exec frontend cat /etc/nginx/conf.d/nginx.conf
```

---

## 生产环境部署

### 1. 使用环境变量
创建 `.env` 文件：
```env
MYSQL_ROOT_PASSWORD=your_secure_password
MYSQL_PASSWORD=your_app_password
```

### 2. 使用 HTTPS
配置 SSL 证书：
```yaml
frontend:
  ports:
    - "443:443"
  volumes:
    - ./ssl:/etc/nginx/ssl
```

### 3. 配置域名
修改 Nginx 配置：
```nginx
server {
    listen 80;
    server_name yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    server_name yourdomain.com;
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ...
}
```

### 4. 配置防火墙
```bash
# 开放端口
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

---

## 卸载

### 完全卸载
```bash
# 1. 停止并删除所有容器和卷
docker-compose down -v

# 2. 删除镜像
docker rmi docker-frontend docker-backend mysql:8.0

# 3. 删除项目目录
cd ..
rm -rf docker-ecommerce-system
```
